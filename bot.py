import random
import telebot
from flask import Flask, request
import os
from waitress import serve

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
TOKEN = os.getenv("TOKEN")  # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
bot = telebot.TeleBot(TOKEN)

# --- –ü—Ä–æ—Ä–æ—á–µ—Å—Ç–≤–∞ –ú–∞–¥–∞–º –õ—é–º–∏–Ω—ã ---
prophecies = [
    "–°–µ–≥–æ–¥–Ω—è —Ç–µ–±–µ –ø—Ä–µ–¥–ª–æ–∂–∞—Ç —Å—Ç—Ä–∞–Ω–Ω—ã–π –≤—ã–±–æ—Ä. –°–¥–µ–ª–∞–π –≤–∏–¥, —á—Ç–æ –∑–Ω–∞–µ—à—å, —á—Ç–æ –¥–µ–ª–∞–µ—à—å.",
    "–ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –∑–∞–¥–∞—Å—Ç —Ç–µ–±–µ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å ‚Äì –ø—Ä–æ—Å—Ç–æ —Å–∫–∞–∂–∏ '–î–∞, –Ω–æ –Ω–µ —Ç–∞–∫, –∫–∞–∫ —Ç—ã –¥—É–º–∞–µ—à—å'.",
    "–í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è —Ç—ã –Ω–∞–π–¥—ë—à—å —á—Ç–æ-—Ç–æ —É—Ç–µ—Ä—è–Ω–Ω–æ–µ. –í–æ–∑–º–æ–∂–Ω–æ, —Å–≤–æ—é –º–æ—Ç–∏–≤–∞—Ü–∏—é. –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ—Å—Ç–æ –Ω–æ—Å–æ–∫.",
    "–û–¥–Ω–∞ –∏–∑ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏—Ö —Ñ—Ä–∞–∑ –æ–∫–∞–∂–µ—Ç—Å—è –ø—Ä–æ—Ä–æ—á–µ—Å–∫–æ–π. –¢—ã –ø–æ–π–º—ë—à—å, –∫–∞–∫–∞—è, –∫–æ–≥–¥–∞ —É–∂–µ –±—É–¥–µ—Ç –ø–æ–∑–¥–Ω–æ.",
    "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–≤–µ—Ä–∏ –ª—É—á—à–µ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å. –û—Å–æ–±–µ–Ω–Ω–æ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –ø–æ—Å–ª–µ 23:00.",
]

# --- –ê—Ä—Ö–µ—Ç–∏–ø –¥–Ω—è ---
archetypes = {
    "–ì–µ—Ä–æ–π": "–°–µ–≥–æ–¥–Ω—è —Ç–≤–æ–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å. –ò–ª–∏ —Ö–æ—Ç—è –±—ã —Å–¥–µ–ª–∞—Ç—å –∑–∞—Ä—è–¥–∫—É.",
    "–¢—Ä–∏–∫—Å—Ç–µ—Ä": "–¢—ã —Å–µ–≥–æ–¥–Ω—è –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º. –î–∞–∂–µ –¥–ª—è —Å–µ–±—è.",
    "–¢–µ–Ω—å": "–ë—É–¥—å –æ—Å—Ç–æ—Ä–æ–∂–µ–Ω: —Å–µ–≥–æ–¥–Ω—è —Ç–µ–±—è –º–æ–≥—É—Ç –ø—Ä–µ—Å–ª–µ–¥–æ–≤–∞—Ç—å —Ç–≤–æ–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –º—ã—Å–ª–∏.",
    "–ú—É–¥—Ä–µ—Ü": "–¢—ã —Å–µ–≥–æ–¥–Ω—è –ø–æ–ª–æ–Ω –∑–Ω–∞–Ω–∏–π. –ò–ª–∏ —Ö–æ—Ç—è –±—ã —É–º–µ–µ—à—å —É–º–Ω–æ –º–æ–ª—á–∞—Ç—å.",
    "–®—É—Ç": "–¢–µ–±–µ –≤—Å—ë –∫–∞–∂–µ—Ç—Å—è –∞–±—Å—É—Ä–¥–æ–º? –û—Ç–ª–∏—á–Ω–æ, —Ç—ã –ø–æ–Ω—è–ª —Å—É—Ç—å –∂–∏–∑–Ω–∏.",
}

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ ---
@bot.message_handler(commands=['start', 'help'])
def send_welcome(message):
    bot.reply_to(message, "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –ú–∞–¥–∞–º –õ—é–º–∏–Ω—ã. –ù–∞–ø–∏—à–∏ /–ø—Ä–æ—Ä–æ—á–µ—Å—Ç–≤–æ –∏–ª–∏ /–∞—Ä—Ö–µ—Ç–∏–ø.")

@bot.message_handler(commands=['–ø—Ä–æ—Ä–æ—á–µ—Å—Ç–≤–æ'])
def send_prophecy(message):
    prophecy = random.choice(prophecies)
    bot.reply_to(message, f"üîÆ {prophecy}")

@bot.message_handler(commands=['–∞—Ä—Ö–µ—Ç–∏–ø'])
def send_archetype(message):
    archetype, description = random.choice(list(archetypes.items()))
    bot.reply_to(message, f"üé≠ –°–µ–≥–æ–¥–Ω—è —Ç–≤–æ–π –∞—Ä—Ö–µ—Ç–∏–ø: *{archetype}*\n_{description}_", parse_mode='Markdown')

# --- Flask –≤–µ–±—Ö—É–∫ ---
app = Flask(__name__)

@app.route(f'/{TOKEN}', methods=['POST'])
def getMessage():
    bot.process_new_updates([telebot.types.Update.de_json(request.stream.read().decode("utf-8"))])
    return "", 200

@app.route('/')
def webhook():
    bot.remove_webhook()
    bot.set_webhook(url=f'https://telegram-bot-ljm6.onrender.com/{TOKEN}')  # ‚Üê –¢–≤–æ–π —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω!
    return "Webhook set", 200

if __name__ == "__main__":
    serve(app, host="0.0.0.0", port=int(os.getenv("PORT", 5000)))
